# Shell Completion for PANFlow

This document explains how to set up shell completion for the PANFlow tool, allowing you to use tab completion for commands and options in your terminal.

## Installation

PANFlow provides shell completion support for Bash, Zsh, and Fish shells. You can install the completion scripts using the built-in `completion` command.

### Using the Packaged Application

If you're using the packaged application (downloaded binary or macOS app), you can install shell completion with:

```bash
./panflow completion --install
```

For macOS application bundles, you can access the binary from:

```bash
# If distributed in the Applications folder
/Applications/PANFlow.app/Contents/MacOS/panflow completion --install

# If using from the build directory
./dist/PANFlow.app/Contents/MacOS/panflow completion --install
```

The packaged application includes a special launcher script that properly handles completion requests, ensuring that shell completion works correctly even with the packaged version.

### Using a Specific Shell

If you want to install completion for a specific shell, use the `--shell` option:

```bash
./panflow completion --install --shell bash
# or
./panflow completion --install --shell zsh
# or
./panflow completion --install --shell fish
```

### Using a Custom Path

If you don't have write permissions to the standard completion directories, you can specify a custom path:

```bash
./panflow completion --install --path ~/.local/share/bash-completion/completions/panflow
# or for zsh
./panflow completion --install --path ~/.zsh/completions/_panflow
# or for fish
./panflow completion --install --path ~/.config/fish/completions/panflow.fish
```

## Completion Locations

The completion scripts are installed to the following locations by default:

### Bash
- macOS (Homebrew): `/usr/local/etc/bash_completion.d/panflow` or `/opt/homebrew/etc/bash_completion.d/panflow`
- macOS (Fallback): `~/.bash_completion.d/panflow`
- Linux: `/etc/bash_completion.d/panflow` or `~/.local/share/bash-completion/completions/panflow`

### Zsh
- macOS (Homebrew): `/usr/local/share/zsh/site-functions/_panflow` or `/opt/homebrew/share/zsh/site-functions/_panflow`
- macOS (Fallback): `~/.zsh/completions/_panflow`
- Linux: `/usr/share/zsh/site-functions/_panflow` or `~/.zsh/completions/_panflow`

### Fish
- All platforms: `~/.config/fish/completions/panflow.fish`

## Manual Installation

If you prefer to manually install the completion scripts, you can generate them with:

```bash
./panflow completion --show > /path/to/completion/script
```

For example:
```bash
# Bash
./panflow completion --show > ~/.bash_completion.d/panflow

# Zsh
./panflow completion --show --shell zsh > ~/.zsh/completions/_panflow

# Fish
./panflow completion --show --shell fish > ~/.config/fish/completions/panflow.fish
```

## Testing Completion

After installing completion, you may need to restart your shell or source the completion script:

### Bash
```bash
source ~/.bash_completion.d/panflow
# or
source /usr/local/etc/bash_completion.d/panflow
```

### Zsh
```bash
autoload -Uz compinit && compinit
```

### Fish
Completion should be available immediately after installation.

## Troubleshooting

### Completion Not Working

1. **Check your shell** - Make sure you're using a supported shell (Bash, Zsh, or Fish).
2. **Check installation path** - Verify that the completion script is installed in the correct location.
3. **Check permissions** - Ensure the completion script is readable.
4. **Reload your shell** - Try logging out and back in, or restart your terminal.
5. **Manual installation** - Try installing to a user-writable location instead of system directories.

### Permission Denied

If you get a "Permission denied" error when installing completion, try:

1. Using a custom path in your home directory:
   ```bash
   ./panflow completion --install --path ~/.local/share/bash-completion/completions/panflow
   ```

2. Using sudo (system-wide installation):
   ```bash
   sudo ./panflow completion --install
   ```

### Command Not Found

If you get a "Command not found" error when trying to use completion, make sure:

1. The `panflow` command is in your PATH
2. You've restarted your shell or sourced the completion script
3. The completion script is installed in a directory that your shell checks for completions

### Packaged Application Specific Issues

When using the packaged application (especially the macOS .app bundle):

1. **Path references** - The completion script generated by the packaged application will reference the absolute path to the executable. If you move the application, you'll need to reinstall the completion scripts.

2. **Path resolution** - In some cases, the shell may not be able to resolve the path to the executable in the application bundle. In these cases, you can create a symlink to the executable in a directory that's in your PATH:
   ```bash
   ln -s /Applications/PANFlow.app/Contents/MacOS/panflow /usr/local/bin/panflow
   ```

3. **Testing with new installation** - After installing a new version, you should reinstall the completion scripts to ensure they reference the correct executable path.

### Debugging Completion

To debug shell completion issues with the packaged application, you can:

1. Test the manual completion mechanism:
   ```bash
   COMP_WORDS=("panflow" "obj") COMP_CWORD=1 ./dist/PANFlow.app/Contents/MacOS/panflow __complete "obj"
   ```
   This should output completion suggestions for the `object` command.

2. Examine the installed completion script to ensure it has the correct path:
   ```bash
   cat ~/.zsh/completions/_panflow  # For Zsh
   # or
   cat ~/.bash_completion.d/panflow  # For Bash
   ```

## Known Issues

- In some shells, you may need to press TAB twice to show completions.
- The packaged macOS application might require macOS permissions to access certain directories.
- Older versions of Bash (<4.0) have limited completion support.
- If the application is moved after installing completion scripts, the scripts may no longer work properly.
- Shell completion in macOS application bundles requires special handling of the `__complete` argument, which is managed by the completion-aware launcher in the packaged application.

## Technical Implementation

This section provides details about how shell completion is implemented in PANFlow, which is useful for developers maintaining the application.

### Architecture Overview

PANFlow's shell completion system consists of the following components:

1. **Typer Framework**: The CLI is built using the Typer framework, which provides built-in completion support.
2. **completion.py**: Handles installation and generation of shell completion scripts.
3. **completions.py**: Provides the completion context and handlers for custom completions.
4. **completion_aware_launcher.py**: Special entry point for the packaged application that properly handles completion requests.

### How Shell Completion Works

1. When a user presses Tab for completion, the shell runs the PANFlow binary with a special `__complete` argument.
2. The binary detects this special argument and generates completion suggestions based on the command context.
3. The shell receives these suggestions and displays them to the user.

### Implementation Details

#### Packaged Application

For the packaged application, we use a special launcher script (`completion_aware_launcher.py`) as the entry point. This script:

1. Properly handles the `__complete` argument from shells
2. Generates shell-specific completion scripts that reference the correct executable path
3. Provides the `completion` command to install these scripts

#### Key Functions

- `get_executable_path()` in `completion.py`: Detects whether we're running from a packaged app and returns the appropriate executable path
- `generate_*_completion()` functions: Create shell-specific completion scripts
- `completion` command: Handles script generation and installation

### Packaging Integration

The macOS application bundle is built using PyInstaller with the following configuration:

1. The spec file (`panflow.spec`) specifies `completion_aware_launcher.py` as the entry point
2. Hidden imports include all necessary modules for completion functionality
3. The application bundle includes proper metadata for macOS

### Build Process

The build process for the packaged application:

1. Uses Poetry for dependency management
2. Packages the application with PyInstaller
3. Creates a macOS application bundle
4. Includes all necessary files for shell completion

### Testing

Shell completion can be tested with:

1. The `test_completion.sh` script which verifies completion functionality
2. Manual testing by installing completion scripts and using Tab completion
3. Direct testing of the completion mechanism using environment variables:
   ```bash
   COMP_WORDS=("panflow" "obj") COMP_CWORD=1 ./dist/PANFlow.app/Contents/MacOS/panflow __complete "obj"
   ```